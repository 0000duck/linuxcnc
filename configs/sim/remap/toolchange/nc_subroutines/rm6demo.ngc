; This demonstrates doing an M6 remapped to a named oword sub
;
; to activate, incantate as follows in the ini file:
;
; [RS274NGC]
; REMAP=M6  prolog=change_prolog  ngc=rm6demo.ngc epilog=change_epilog
;
O<rm6demo> sub
;
(DEBUG,rm6demo tool_in_spindle=#<tool_in_spindle> selected_pocket=#<selected_pocket>)

;???????
M66 P2 L0
;(debug, digital-input-02=#5399)

#<tool_change_with_spindle_on> = 0
#<tool_change_quill_up> = 0
#<tool_change_at_g30> = 0

; number of seconds to wait for 'tool-changed' equivalent
#<timeout> = 9999

O100 if [#<tool_change_with_spindle_on>] EQ 0
    M5
O100 endif

O200 if [#<tool_change_quill_up> NE 0]
    G0 G53 Z0
O200 endif
 
O300 if [#<tool_change_at_g30> NE 0]
    G30
O300 endif

; set analog output pin #2 to signal the pocket number
; iocontrol.tool-number becomes motion.analog-out-02
M68 E2 Q[#<selected_pocket>]
;(DEBUG, set current tool number on motion.analog-out-02: #<selected_pocket>)
;
; assert the equivalent of the iocontrol.tool-change pin
; which is now motion.digital-out-01
M64 P1
;(DEBUG, motion.digital-out-01 set high, waiting for motion.digital-in-01)


; wait for the equivalent of the iocontrol.tool-changed pin to go high
; we use motion.digital-in-01
;
M66 P1 L3 Q#<timeout>
;
; if we waited too long, fail change and abort.
;
O400 if [#5399 EQ -1]
    (DEBUG, timeout waiting for digital-in-01 to become true - failing change )
    O<rm6demo> return [-1]
O400 endif

; retract iocontrol.tool-change equivalent
;(DEBUG, deasserting motion.digital-out-01)
M65 P1


; test fail-change line from gladevcp
M66 P2 L0
; (debug, digital-input-02=#5399)
O500 if [#5399 EQ 1]
    (DEBUG, returning -1 to fail change)
    O<rm6demo> return [-1]
O500 else
    (debug, change ok, returning +1 to commit change)
    ; a positive return value commits the tool change
    O<rm6demo> return [1]
O500 endif
;
; return a positive value commit the change.
; a negative return value will fail the change and
; abort the interpreter with a message like
; "M6 failed (<return value>)"
;
O<rm6demo> endsub
m2
