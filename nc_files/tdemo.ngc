; This demonstrates doing T<pocket> select tool command
; remapped to a named oword sub
;
; to activate, incantate as follows in the ini file:
; [RS274NGC]
; # remap T<pocket> to a named oword subroutine.
; # The tool number will be passed as parameter #1
; # The pocket number will be passed as parameter #2
;
; T_COMMAND=o<tdemo>call
;
; NB: param #3 at this point in time is useless - dont rely on its value.
; This will change once iocontrol is history, and tooltable I/O is
; moved to the interpreter.
;
;-----------------
; emulate the tool-number/tool-prepare/tool-prepared logic of the iocontrol-
; based toolchanger
;
O<tdemo> sub

m66 E0 L0 (analog-in-00 = #5399)
#<ain00> = #5399

; test fail-change line from gladevcp
M66 P2 L0

(debug, digital-input-02=#5399)
O<tdemo_prepare_fail> if [#5399 EQ 1]
    (DEBUG, FAILING PREPARE, analog-in-00=#<ain00>, returning -1 to fail prepare)
    ; a return value <= 0 fails the tool prepare
    O<tdemo> return [-1]
; O<tdemo_prepare_fail> else
;     (debug, prepare ok, returning +1 to commit prepare)
;     ; a positive return value commits the tool prepare
;     O<tdemo> return [1]
O<tdemo_prepare_fail> endif


; O<tdemo> if  ; trigger error to test error reporting
;
; number of seconds to wait for 'tool-prepared' equivalent
#<timeout> = 9999
;
(DEBUG, executing T #1 in O-word sub)
;
; set analog output pin #0 to signal the tool number
; iocontrol.tool-prep-number becomes motion.analog-out-00
M68 E0 Q[#1]
(DEBUG, set tool number on motion.analog-out-00: #1)
;
; set analog output pin #1 to signal the pocket number
; iocontrol.tool-prep-pocket becomes motion.analog-out-01
M68 E1 Q[#2]
(DEBUG, set pocket number on motion.analog-out-01: #2)
;
;
; assert the equivalent of the iocontrol.tool-prepare pin
; which is now motion.digital-out-00
M64 P0
(DEBUG, motion.digital-out-00 set high, waiting for motion.digital-in-00)
;
;
; wait for the equivalent of the iocontrol.tool-prepared pin to go high
; we use motion.digital-in-00
;
M66 P0 L3 Q#<timeout>
;
O<tdemo_timeout> if [#5399] EQ -1
    (DEBUG, timeout waiting for motion.digital-in-00 to become true: #5399 )
O<tdemo_timeout> else
    (DEBUG, motion.digital-in-00 became true: #5399)
O<tdemo_timeout> endif

(DEBUG, deasserting motion.digital-out-00)
;
M65 P0
;
;
(DEBUG, done with prepare sub)



; succeed prepare if not explicitly succeeded or failed above
O<tdemo> endsub [1]


m2
