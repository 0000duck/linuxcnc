INCLUDES += rtapi

../include/%.h: ./rtapi/%.h
	cp $^ $@
../include/%.hh: ./rtapi/%.hh
	cp $^ $@

# defaults for kernel thread styles
# there's no rtapi_app  
RTAPI_APP_SRCS := 

# flags for ULAPI linking; used in ../lib/liblinuxcnchal.so
ULAPI_LINK := 

#  ---------------- kernel thread styles ----------------
ifeq ($(THREADS),rtai)
ULAPISRCS := rtapi/rtai_ulapi.c
endif

ifeq ($(THREADS),xenomai-kernel)

ULAPISRCS := rtapi/xenomai_ulapi.c

XENO_CONFIG ?= xeno-config --skin=native
XENO_CFLAGS := $(shell $(XENO_CONFIG) --cflags )
ULAPI_LINK += $(shell $(XENO_CONFIG) --ldflags )

$(call TOOBJSDEPS, $(ULAPISRCS)): EXTRAFLAGS += -fPIC $(XENO_CFLAGS)
endif

#  ---------------- userland thread styles ----------------
# for now, handle all three rtapi_app flavors through conditional compilation in
# the sim_rtapi*c files

ifeq ($(THREADS),posix)
RTAPI_APP_SRCS := \
	rtapi/sim_rtapi_app.cc \
	rtapi/rtapi_common.c \
	rtapi/rtapi_pci.c \
	rtapi/sim_rtapi.c

ULAPISRCS := rtapi/sim_ulapi.c

PTH_CONFIG ?= pth-config
RTAPI_CFLAGS := $(shell $(PTH_CONFIG) --cflags 2>/dev/null)
RTAPI_LINK := $(shell $(PTH_CONFIG) --ldflags --libs 2>/dev/null)

$(call TOOBJSDEPS, $(RTAPI_APP_SRCS)): EXTRAFLAGS += $(RTAPI_CFLAGS)
../bin/rtapi_app: $(call TOOBJS, $(RTAPI_APP_SRCS))
	$(ECHO) Linking $(notdir $@)
	@$(CXX) -rdynamic $(LDFLAGS) -o $@ $^ -ldl $(RTAPI_LINK)
TARGETS += ../bin/rtapi_app

endif

ifeq ($(THREADS),xenomai-user)
XENO_CONFIG ?= xeno-config --skin=native
XENO_CFLAGS := $(shell $(XENO_CONFIG) --cflags )

RT_CFLAGS +=  $(XENO_CFLAGS)
RTAPI_APP_SRCS := \
	rtapi/sim_rtapi_app.cc \
	rtapi/xenomai_common.c \
	rtapi/rtapi_common.c \
	rtapi/rtapi_pci.c \
	rtapi/sim_rtapi.c

ULAPISRCS := rtapi/sim_ulapi.c

$(call TOOBJSDEPS, $(RTAPI_APP_SRCS)): EXTRAFLAGS =  $(XENO_CFLAGS)

../bin/rtapi_app: $(call TOOBJS, $(RTAPI_APP_SRCS))
	$(ECHO) Linking $(notdir $@) $(ULAPI_LINK)
	$(CXX) -rdynamic $(LDFLAGS) -o $@ $^ -ldl $(shell $(XENO_CONFIG) --ldflags) 

$(call TOOBJSDEPS, $(ULAPISRCS)): EXTRAFLAGS = -fPIC  $(shell $(XENO_CONFIG) --cflags) 

TARGETS += ../bin/rtapi_app

endif

ifeq ($(THREADS),rt-preempt-user)

# Sources needed to be linked into ../bin/rtapi_app
# (Can some of these be trimmed out and moved into ULAPISRCS?)
RTAPI_APP_SRCS := \
	rtapi/rtapi_common.c \
	rtapi/rtapi_msg.c \
	rtapi/rtapi_shmem.c \
	rtapi/rtapi_time.c \
	rtapi/rtapi_pci.c \
	rtapi/rtapi_task.c \
	rtapi/$(THREADS).c

# The full list of RTAPI sources.
# These will be compiled twice:
# - once with -DRTAPI for the ../rtlib/* modules
# - once with -DULAPI for ../lib/liblinuxcnchal.so
ULAPISRCS := $(RTAPI_APP_SRCS) \
	rtapi/rtapi_io.c

# Compile flags for objects/rtrtapi/*.o
RT_CFLAGS +=  -lpthread -lrt

# HACK:  This should be in RTAPI_APP_SRCS, but those need to be
# compiled with -DRTAPI.  This could be also, but the Makefile doesn't
# know how to compile C++ RTAPI sources, so for now it's hacked in
# here.
USERSRCS +=  rtapi/sim_rtapi_app.cc

# HACK:  prepending 'rt' ('rtrtapi/rtapi_foo.o') so that RTAPI_APP_SRCS
# are compiled with -DRTAPI.  The sim_rtapi_app object file must be
# specified separately for the reason described above.
../bin/rtapi_app: $(call TOOBJS, $(patsubst %,rt%, $(RTAPI_APP_SRCS))) \
			objects/rtapi/sim_rtapi_app.o
	$(ECHO) Linking $(notdir $@)
	$(Q)$(CXX) -rdynamic $(LDFLAGS) -o $@ $^ -ldl -lpthread -lrt
TARGETS += ../bin/rtapi_app
endif


USERSRCS += $(RTAPI_APP_SRCS)
rtapi-objs := $(patsubst %.c, %.o, $(ULAPISRCS))
