# Makefile for real-time and user-level API

# get the defs for CC, CFLAGS, LIB_DIR, etc.
include ../../Makefile.inc

# Public headers
HEADERS = \
procfs_macros.h \
rtapi.h \
rtapi_app.h

# Private headers
PRIVHDRS = \
rtapi_common.h \
rtapi_proc.h \
vsnprintf.h

# Sources
SRCS = \
$(RTPREFIX)_ulapi.c

RT_SRCS = \
$(RTPREFIX)_rtapi.c \
mathstubs.c

# Libraries to be created
LIBS = \
$(RTLIB_DIR)/rtapi.o \
$(LIB_DIR)/ulapi.o \
$(RTTMP_DIR)/mathstubs.o

all: headers $(LIBS)
	@ echo "Set up RTOS symlinks"
	@ if [ -f $(EMC2_HOME)/scripts/load_$(RTPREFIX) ] ; \
	then \
	  ln -fs $(EMC2_HOME)/scripts/load_$(RTPREFIX) \
	    $(EMC2_HOME)/scripts/load_rtos ; \
	else \
	  echo "ERROR: $(EMC2_HOME)/scripts/load_$(RTPREFIX) not found" ; \
	fi
	@ if [ -f $(EMC2_HOME)/scripts/unload_$(RTPREFIX) ] ; \
	then \
	  ln -fs $(EMC2_HOME)/scripts/unload_$(RTPREFIX) \
	    $(EMC2_HOME)/scripts/unload_rtos ; \
	else \
	  echo "ERROR: $(EMC2_HOME)/scripts/unload_$(RTPREFIX) not found" ; \
	fi

# Generic rules
include ../../Make.rules

examples:
	(cd examples; make all)

headers: def_headers
	(cd examples; make $@)

indent: def_indent
	(cd examples; make $@)

depend: def_depend
	(cd examples; make $@)

clean: def_clean
	@ echo "Remove RTOS symlinks"
	- rm $(EMC2_HOME)/scripts/load_realtime_base 2> /dev/null
	- rm $(EMC2_HOME)/scripts/unload_realtime_base 2> /dev/null
	# note that we always clean the examples, even if not
	# configured to make them
	(cd examples; make $@)

# explicit rules to make libs from objs

$(RTLIB_DIR)/rtapi.o : $(RTTMP_DIR)/$(RTPREFIX)_rtapi.o
	@ echo "Install rtapi.o in rtlib"
	- \install -p -m0664 $< $(RTLIB_DIR)/rtapi.o


$(LIB_DIR)/ulapi.o : $(TMP_DIR)/$(RTPREFIX)_ulapi.o
	@ echo "Install ulapi.o in lib"
	- \install -p -m0664 $< $(LIB_DIR)/ulapi.o

# This is a list of the realtime modules provided by the OS
# that are to be loaded - Some will not be present on certain
# systems, but they still need to be listed if systems that do have
# them are to work.
RTAI_MOD="adeos rtai rt_mem_mgr rtai_sched rtai_fifos rtai_shm rtai_libm rtai_math"
RTL_MOD="rtl mbuff rtl_time rtl_sched rtl_posixio rtl_fifo"

rtapi.conf:
	@ echo "# Autogenerated file by 'make rtapi.conf'" > $(EMC2_HOME)/scripts/rtapi.conf
	@ echo "# A few parameters from emc2/Makefile.inc" >> $(EMC2_HOME)/scripts/rtapi.conf
	@ echo "EMC2_HOME='$(EMC2_HOME)'" >> $(EMC2_HOME)/scripts/rtapi.conf
	@ echo "MAN_DIR='$(MAN_DIR)'" >> $(EMC2_HOME)/scripts/rtapi.conf
	@ echo "KERNELDIR='$(KERNELDIR)'" >> $(EMC2_HOME)/scripts/rtapi.conf
	@ echo "RTDIR='$(RTDIR)'" >> $(EMC2_HOME)/scripts/rtapi.conf
	@ echo  >> $(EMC2_HOME)/scripts/rtapi.conf
	@ mod_dir=$$(find /lib/modules/`uname -r` -name "mbuff.o" -o -name "rtai_sched.o") ; \
	  if [ "$$mod_dir" = "" ] ; then \
	     echo "# Path to the realtime kernel modules" >> $(EMC2_HOME)/scripts/rtapi.conf; \
	     echo "MODPATH='$(RTDIR)/modules'"  >> $(EMC2_HOME)/scripts/rtapi.conf ; \
	  fi
	@ echo >> $(EMC2_HOME)/scripts/rtapi.conf
	@ echo "# List of realtime kernel modules to be loaded" >> $(EMC2_HOME)/scripts/rtapi.conf
	@ if [ "$(RTPREFIX)" = "rtai" ] ; \
	    then echo "MODULES='$(RTAI_MOD)'" >> $(EMC2_HOME)/scripts/rtapi.conf ; \
	  elif [ "$(RTPREFIX)" = "rtl" ] ; \
	    then echo "MODULES='$(RTL_MOD)'" >> $(EMC2_HOME)/scripts/rtapi.conf ; \
	  fi

.PHONY: all examples headers depend indent install clean

